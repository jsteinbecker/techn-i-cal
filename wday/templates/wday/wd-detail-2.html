{% extends 'base.html' %}



{% block content %}

    <div class="w-full">
        <div class="text text-center">
            <a href="{{ workday.prevWD.url }}"><i class="fa-duotone fa-circle-arrow-left"></i></a>
            <span class="text-2xl"> {{ workday }} </span>
            <a href="{{ workday.nextWD.url }}"><i class="fa-duotone fa-circle-arrow-right"></i></a>
        </div>
    </div>

    <div class="all-shifts">

        <div class="opacity-0 trashbin text-center p-4" 
                ondragover="event.preventDefault();"
                ondragleave="backdropDragLeave(event);"
                ondrop="dropInTrash(event);"
                ondragend="backdropDragEnd(event);">
                <i class="fa-duotone fa-dumpster text-xl bg-red-400 h-12 w-12 rounded-full border border-red-800"></i>
            </div>

        {% for slot in workday.slots.all %}

            <div class="slot flex flex-row" 
                 id="{{ slot.shift }}" 
                 data-available="{% for e in slot.fills_with.all %}{{ e }} {% endfor %}"
                 ondragover="dragOverVerify(event);"
                 ondrop="drop(event);"
                 ondragleave="dragLeave(event);"
                 >

                <span class="shift px-1"> 
                    {{ slot.shift }} 
                </span>

                {% if slot.employee %} 

                    <span class="employee" 
                          id="{{ slot.employee.pk }}"
                          draggable="true"
                          ondragstart="emplInSlotDragStart(event);revealTrashbins(event);"
                          ondragend="employeeDragEnd(event);hideTrashbins(event);"
                          > 
                          {{ slot.employee }}  
                    </span> 

                {% endif %}
                
            </div>

        {% endfor %}

        <div class="opacity-0 trashbin text-center p-4 py-8" 
            ondragover="dragOverTrash(event);"
            ondragenter="dragEnterTrash(event);"
            ondragleave="backdropDragLeave(event);"
            ondrop="dropInTrash(event);"
            ondragend="backdropDragEnd(event);">
            <i class="fa-duotone fa-dumpster text-xl bg-red-400 h-12 w-12 rounded-full border border-red-800"></i>
        </div>

    </div>


    <div class="flex flex-row">

        <div class="on-deck w-4/12 text-right">
            
            <!------ CONTAINER FOR EMPLOYEES ON DECK -------
            ________________________________________________-->
            <div class="text-2xl text-emerald-400">ON DECK</div>

            {% for empl in workday.on_deck.all %}
                <div class="employee" 
                     id="{{ empl.pk }}"
                     draggable="true"
                     ondragstart="employeeDragStart(event);"
                     ondragend="employeeDragEnd(event);">
                    <span class="bg-emerald-400 rounded px-3"> {{ empl }} </span>
                </div>
            {% endfor %}
        </div>

        <div class="on-pto w-4/12 text-center">

            <!------ CONTAINER FOR EMPLOYEES ON PTO -------
            ________________________________________________-->
            <div class="text-2xl text-amber-400">PTO</div>

            {% for empl in workday.pto.all %}
                <div class="employee" 
                    id="{{ empl.pk }}"
                    draggable="true"
                    >
                    <span class="bg-amber-400 rounded px-3"> {{ empl.employee }} </span>
                </div>
            {% endfor %}
        </div>

        <div class="on-tdo w-4/12 text-left">

            <div class="text-2xl text-gray-400">TDO</div>

            {% for empl in workday.tdo.all %}
                <div class="employee" 
                     id="{{ empl.employee.pk }}"
                     draggable="true"
                     >
                    <span class="bg-slate-400 bg-opacity-60  rounded px-3"> {{ empl.employee }} </span>
                </div>
            {% endfor %}
        </div>

    </div>

    <div class="text text-center text-2xs opacity-75">USING TEMPLATE: WD-DEFAULT </div>


    <script>

        var dragType = '';
        // on load get all slots attr data-available and split it by " " into an array
        // then for each employee in the array, check if the employee is in the on-deck
        function employeeDragStart (event) {
            event.dataTransfer.setData('text', event.target.id);
            console.log(event.target.id);
            // select slots with event.target.id in data-available.split(" ")
            // add class hold to each slot
            document.querySelectorAll('.slot').forEach(slot => {
                if (slot.dataset.available.split(" ").includes(event.target.id)) {
                    slot.classList.add('bg-green-400');
                    // add a visible dropzone to the edge of the slots
                    slot.innerHTML += '<div class="dropzone"><i class="fa-duotone fa-target text-xl text-zinc-800 opacity-70"></i></div>';
                }
            })
            
            }
        
        function employeeDragEnd (event) {
            // remove class hold from all slots
            document.querySelectorAll('.slot').forEach(slot => {
                slot.classList.remove('bg-green-400','ring','ring-green-300','ring-offset-2');
            })
            // remove all dropzones
            document.querySelectorAll('.dropzone').forEach(dropzone => {
                dropzone.remove();
            })
        }

        function dragOverVerify (event) {
            if (event.target.classList.contains('slot')) {
                if (event.target.dataset.available.split(" ").includes(event.dataTransfer.getData('text'))) {
                    event.preventDefault();
                    event.target.classList.add('ring','ring-green-300','ring-offset-2');
                }
            }
        }
        
        function dragOverTrash (event) {
            event.preventDefault();
        }

        function dragEnterTrash (event) {
            event.target.classList.add('ring','ring-red-300','ring-offset-2');
        }

        function dragLeaveTrash (event) {
            event.target.classList.remove('ring','ring-red-300','ring-offset-2');
        }

        

        function revealTrashbins (event) {
            document.querySelectorAll('.trashbin').forEach(trashbin => {
                trashbin.classList.remove('opacity-0');
            })
        }

        function hideTrashbins (event) {
            document.querySelectorAll('.trashbin').forEach(trashbin => {
                trashbin.classList.add('opacity-0');
            })
        }

        function dragLeave (event) {
            event.target.classList.remove('ring','ring-green-300','ring-offset-2');
        }

        function drop (event) {
            // remove my last child 
            // for child in event.target.children  if child.class == employee remove child
            for (let i = 0; i < event.target.children.length; i++) {
                if (event.target.children[i].classList.contains('employee')) {
                    event.target.children[i].remove();
                }
            }
            // get data from drop
            const data = event.dataTransfer.getData('text');
            
            // set animation on slot being updated
            event.target.classList.add('fa-fade');
            event.target.appendChild(document.getElementById(data));

            document.querySelectorAll('.slot').forEach(slot => {
                slot.classList.remove('bg-green-400','ring','ring-green-300','ring-offset-2');
            })

            // update the database
            const slot = event.target.id;
            const employee = data;
            const url = `slot/${slot}/update/${employee}/`;
            
            fetch(url)
                .then(response => response)
                .then(data => {
                    console.log(data);
                    // wait 750ms then reload the page
                    setTimeout(() => {
                        window.location.reload();
                    }, 750);
                })
        }
        function emplInSlotDragStart (event) {
            event.dataTransfer.setData('text', event.target.id);
            console.log(event.target.id);
            // select slots with event.target.id in data-available.split(" ")
            // add class hold to each slot
            document.querySelectorAll('.slot').forEach(slot => {
                if (slot.dataset.available.split(" ").includes(event.target.id)) {
                    slot.classList.add('bg-green-400');
                }
            })
            document.querySelectorAll('.trashbin').forEach(trashbin => {
                trashbin.classList.remove('hidden');
            })
            dragType = 'inSlot';
        }
        function backdropDragOver (event) {
            if (dragType == 'inSlot') {
                event.preventDefault();
                event.target.classList.add('bg-slate-600');
            }
        }
        function backdropDragLeave (event) {
            event.target.classList.remove('bg-slate-600');
        }

        function backdropDragEnd (event) {
            event.target.classList.remove('bg-slate-600');
            dragType = '';
            document.querySelectorAll('.slot').forEach(slot => {
                 slot.classList.remove('bg-green-400'); 
            })
        }

        function dropInTrash (event) {

            event.target.classList.remove('bg-slate-600');
            // remove the .employee from the .slot it originated from 
            const slot = document.getElementById(event.dataTransfer.getData('text')).parentNode;
            slot.removeChild(document.getElementById(event.dataTransfer.getData('text')));
            slot.classList.add('fa-fade', 'fa-beat');
            // get data from drop
            const data = event.dataTransfer.getData('text');
            // get .shift that is child of .slot element 
            const shift = slot.children[0].innerText;
            console.log('Clearing Slot: ', shift)
            document.querySelectorAll('.slot').forEach(slot => {
                slot.classList.remove('bg-green-400','ring','ring-green-300','ring-offset-2');
            })

            
            const employee = data;
            const url = `slot/${shift}/delete/`;

            dragType = '';


            fetch(url)
                .then(response => response)
                .then(data => {
                    console.log(data);
                    // wait 750ms then reload the page
                    setTimeout(() => {
                        window.location.reload();
                    }, 750);
                })
        }
    

    </script>

{% endblock %}


{% block style %}

    <style>
        .all-shifts {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            align-content: center;
            margin-top: 50px;
        }
        .slot {
            width: 175px;
            height: 50px;
            border: 1px solid white;
            border-radius: 10px;
            margin: 10px;
            padding-left: 10px;
            padding-top: 2px;
        }
        .employee {
            color: #aacc99;
            font-style: bold;
            margin-right: 10px;
        }
        .shift {
            font-style: italic;
            font-size: 22px;
            color: #ffffff;
            
        }
        .hold {
            opacity: 0.5;
        }

    </style>

{% endblock %}